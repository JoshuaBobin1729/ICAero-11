import ee

# Authenticate and initialize Earth Engine
ee.Authenticate()
ee.Initialize(project='reuben-datathon-s')

# Define a list of locations (latitude, longitude) for hot and cold regions
locations = {
    "South Kensington, London": [51.4988, -0.1749],
    "Sahara Desert, Africa": [23.4162, 25.6628],  # Hot region
    "Siberia, Russia": [67.5, 105.0],  # Cold region
    "Amazon Rainforest, Brazil": [-3.4653, -62.2159],  # Warm tropical region
    "Antarctica": [-82.8628, 135.0]  # Extremely cold region
}

# Define the time range from January 2000 to September 2024
start_year = 2000
end_year = 2024

# Function to calculate average downward radiation by sampling every 100th data point
def calculate_average_downward_radiation(latitude, longitude):
    # Define the area of interest (AOI) as a point with a 10 km buffer (smaller buffer for faster processing)
    aoi = ee.Geometry.Point([longitude, latitude]).buffer(10000)  # 10 km buffer

    # Select the ERA5 dataset (surface downward shortwave radiation)
    era5 = ee.ImageCollection('ECMWF/ERA5_LAND/HOURLY').filterBounds(aoi).select('surface_solar_radiation_downwards')

    # Initialize a list to store the yearly mean values
    yearly_means = []

    # Loop over each year and calculate the mean by sampling every 100th data point
    for year in range(start_year, end_year):
        start_date = f'{year}-01-01'
        end_date = f'{year}-12-31'

        # Filter the dataset to the specific year
        yearly_data = era5.filterDate(start_date, end_date)

        # Get the list of images from the yearly_data
        image_list = yearly_data.toList(yearly_data.size())

        # Create a list of indices for every 100th image
        indices = ee.List.sequence(0, image_list.size().subtract(1), 100)

        # Map the indices to obtain a list of image IDs
        sampled_ids = indices.map(lambda i: ee.Image(image_list.get(i)).id())

        # Filter the yearly_data collection to keep only the sampled images
        sampled_data = yearly_data.filter(ee.Filter.inList('system:index', sampled_ids))

        # Calculate the mean of the sampled data
        mean_sampled = sampled_data.mean()

        # Reduce the region to get the average downward radiation for the AOI
        mean_dict = mean_sampled.reduceRegion(
            reducer=ee.Reducer.mean(),
            geometry=aoi,
            scale=10000,  # Smaller buffer for faster processing
            maxPixels=1e13
        )

        # Get the mean downward radiation for the year
        mean_radiation = mean_dict.getInfo().get('surface_solar_radiation_downwards')
        if mean_radiation:
            yearly_means.append(mean_radiation)

    # Calculate the average of the yearly mean values
    if yearly_means:
        overall_mean = sum(yearly_means) / len(yearly_means)
        return overall_mean
    else:
        return None

# Loop over the locations and calculate average downward radiation for each one
for location, coords in locations.items():
    latitude, longitude = coords
    average_radiation = calculate_average_downward_radiation(latitude, longitude)

    # Print the result with the location name, latitude, and longitude
    if average_radiation is not None:
        print(f"Average Surface Downward Radiation at {location} ({latitude}, {longitude}) "
              f"(2000 - 2024): {average_radiation:.2f} J/mÂ²")
    else:
        print(f"No data available for {location} ({latitude}, {longitude}).")
